# Generic Metadata Registry Migration Plan

Goal: Replace the OpenAPI-specific builder hooks in `r2e-core` with a generic
metadata registry so plugins can consume typed metadata without special-case
APIs, while keeping macro-generated code monomorphic.

## Current State (Summary)
- `AppBuilder` stores `route_metadata: Vec<Vec<RouteInfo>>` and
  `openapi_builder: Option<FnOnce(Vec<Vec<RouteInfo>>) -> Router<T>>`.
- `Controller::route_metadata()` (generated by `r2e-macros`) returns the
  OpenAPI-specific `RouteInfo` collection.
- `r2e-openapi` registers `with_openapi_builder(...)` to add `/openapi.json`
  and `/docs` routes.

## Target Design
Introduce a generic, type-erased `MetaRegistry` in `r2e-core` that can store
arbitrary metadata keyed by type. Plugins register a typed consumer with
`AppBuilder::with_meta_consumer::<M>(...)`, and controllers/macro code push
their metadata into the registry via `Controller::register_meta(&mut MetaRegistry)`.

### New Core Types
- `MetaRegistry` (new module, e.g. `r2e-core/src/meta.rs`)
  - Stores `HashMap<TypeId, Box<dyn Any + Send + Sync>>`.
  - Typed API:
    - `push<M: Any + Send + Sync>(item: M)`
    - `extend<M: Any + Send + Sync>(items: impl IntoIterator<Item = M>)`
    - `take<M: Any + Send + Sync>() -> Vec<M>`
    - `get<M: Any + Send + Sync>() -> Option<&[M]>` (optional; avoids draining)
- `MetaConsumer<T>` (internal to `AppBuilder`)
  - Holds a `Box<dyn FnOnce(&mut MetaRegistry) -> Router<T> + Send>`.

### Controller Trait Changes
- Add `fn register_meta(registry: &mut MetaRegistry)` with a default no-op.
- Keep `fn route_metadata() -> Vec<RouteInfo>` but mark as `#[deprecated]`.
  - Default `register_meta` can call `route_metadata()` to keep older code
    working until macros are updated.

### Builder Changes
- Replace `route_metadata` and `openapi_builder` in `AppBuilder` with:
  - `meta_registry: MetaRegistry`
  - `meta_consumers: Vec<MetaConsumer<T>>`
- Add `AppBuilder::with_meta_consumer::<M, F>(f: F)` where:
  - `F: FnOnce(Vec<M>) -> Router<T> + Send + 'static`
  - Implementation stores a consumer that calls `registry.take::<M>()`
    and merges the resulting router during `build_inner()`.
- Keep `with_openapi_builder(...)` as a deprecated wrapper that forwards to
  `with_meta_consumer::<RouteInfo>(...)` for compatibility.

### Metadata Type Location
Keep `RouteInfo`, `ParamInfo`, and `ParamLocation` in `r2e-core` but move them
to a neutral module (`r2e_core::meta`), then re-export from
`r2e_core::openapi` to avoid breaking imports. This decouples the builder from
OpenAPI without removing the type.

## Implementation Plan (Step-by-Step)
1. Add `MetaRegistry` in `r2e-core`:
   - New file: `r2e-core/src/meta.rs`.
   - Implement `MetaRegistry` and typed APIs (`push`, `extend`, `take`, `get`).
   - Re-export from `r2e-core/src/lib.rs`.
2. Move metadata types to `meta`:
   - Move `RouteInfo`, `ParamInfo`, `ParamLocation` from
     `r2e-core/src/openapi.rs` into `r2e-core/src/meta.rs`.
   - Add `pub mod openapi { pub use crate::meta::{...}; }` to keep old paths.
3. Update `Controller` trait:
   - Add `register_meta(&mut MetaRegistry)`.
   - Deprecate `route_metadata()`.
   - Default `register_meta` forwards to `route_metadata()` for backwards
     compatibility (temporary).
4. Update `AppBuilder`:
   - Add `meta_registry: MetaRegistry` and `meta_consumers` fields.
   - In `register_controller`, call `C::register_meta(&mut self.meta_registry)`.
   - Implement `with_meta_consumer::<M>()`.
   - Replace the OpenAPI builder invocation in `build_inner()` with a loop
     over `meta_consumers` that merges each router.
   - Keep `with_openapi_builder(...)` as `#[deprecated]` wrapper.
5. Update `r2e-macros`:
   - Generate `Controller::register_meta` implementation in
     `r2e-macros/src/codegen/controller_impl.rs` that pushes `RouteInfo` items
     into the registry.
   - Optionally keep generating `route_metadata()` for old consumers; mark
     it deprecated in trait definition only.
6. Update `r2e-openapi`:
   - Replace `with_openapi_builder(...)` usage with
     `with_meta_consumer::<RouteInfo>(...)`.
   - Simplify `openapi_routes` to accept a flat `Vec<RouteInfo>`.
7. Docs and examples:
   - Update README and docs to reference `with_meta_consumer` (or the plugin
     API only, to hide the registry details from end-users).
   - Note deprecations and migration path.
8. Cleanup phase (later):
   - Remove `with_openapi_builder` and `route_metadata()` when downstream
     users and internal crates no longer reference them.

## Migration Notes / Compatibility
- Existing code using `r2e_core::openapi::RouteInfo` continues to work via
  re-exports.
- `r2e-openapi` can migrate immediately; other plugins can follow.
- Macro-generated code stays monomorphic: metadata only affects build-time
  router assembly, not request handling.

## Validation Checklist
- `cargo check --workspace` (ensure no missing imports or trait changes)
- Confirm `/openapi.json` and `/docs` still register correctly through the
  OpenAPI plugin after switching to the registry.
*** End Patch}"}}
